<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DAIMON - Central de Operacoes</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        :root {
            --bg: #0a0a0a;
            --surface: #141414;
            --border: #2a2a2a;
            --text: #e0e0e0;
            --muted: #888;
            --accent: #3b82f6;
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, monospace;
            background: var(--bg);
            color: var(--text);
            font-size: 13px;
            line-height: 1.4;
        }
        .ops-grid {
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            grid-template-rows: auto 1fr;
            height: 100vh;
            gap: 1px;
            background: var(--border);
        }
        .panel {
            background: var(--surface);
            padding: 12px;
            overflow: auto;
        }
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }
        .panel-title {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--muted);
        }
        header.panel {
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 16px;
        }
        .logo { font-weight: bold; font-size: 14px; }
        .logo span { color: var(--accent); }
        .status-row {
            display: flex;
            gap: 16px;
            font-size: 11px;
        }
        .status-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--muted);
        }
        .dot.online { background: var(--success); }
        .dot.offline { background: var(--error); }
        .dot.warning { background: var(--warning); }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 2px;
            margin-bottom: 12px;
        }
        .tab {
            padding: 6px 12px;
            background: transparent;
            border: none;
            color: var(--muted);
            cursor: pointer;
            font-size: 12px;
            border-bottom: 2px solid transparent;
        }
        .tab:hover { color: var(--text); }
        .tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        .stat-box {
            background: var(--bg);
            padding: 10px;
            border-radius: 4px;
        }
        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: var(--accent);
        }
        .stat-label {
            font-size: 10px;
            color: var(--muted);
            text-transform: uppercase;
        }

        /* Lists */
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid var(--border);
        }
        .list-item:hover { background: var(--bg); }
        .list-item:last-child { border-bottom: none; }

        /* Buttons */
        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: opacity 0.2s;
        }
        .btn:hover { opacity: 0.8; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--error); color: white; }
        .btn-sm { padding: 4px 8px; font-size: 10px; }

        /* Forms */
        input, textarea, select {
            width: 100%;
            padding: 8px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text);
            font-size: 12px;
            margin-bottom: 8px;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--accent);
        }
        label {
            display: block;
            font-size: 11px;
            color: var(--muted);
            margin-bottom: 4px;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        th {
            color: var(--muted);
            font-weight: normal;
            text-transform: uppercase;
            font-size: 10px;
        }
        tr:hover td { background: var(--bg); }

        /* Log stream */
        .log-stream {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            background: var(--bg);
            padding: 8px;
            border-radius: 4px;
            max-height: 200px;
            overflow: auto;
        }
        .log-entry {
            padding: 2px 0;
            border-bottom: 1px solid var(--border);
        }
        .log-time { color: var(--muted); }
        .log-type {
            display: inline-block;
            width: 60px;
            font-size: 10px;
        }
        .log-type.approval { color: var(--success); }
        .log-type.rejection { color: var(--error); }

        /* Charts */
        .chart-container {
            position: relative;
            height: 150px;
            margin-bottom: 12px;
        }

        /* File upload */
        .upload-zone {
            border: 2px dashed var(--border);
            padding: 20px;
            text-align: center;
            border-radius: 4px;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        .upload-zone:hover { border-color: var(--accent); }
        .upload-zone.dragover { border-color: var(--success); background: rgba(34,197,94,0.1); }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal {
            background: var(--surface);
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        .modal-close {
            background: none;
            border: none;
            color: var(--muted);
            cursor: pointer;
            font-size: 18px;
        }

        /* Search */
        .search-box {
            position: relative;
        }
        .search-box input {
            padding-left: 30px;
        }
        .search-icon {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--muted);
        }

        /* Progress */
        .progress-bar {
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: var(--accent);
            transition: width 0.3s;
        }

        /* Text utilities */
        .text-success { color: var(--success); }
        .text-error { color: var(--error); }
        .text-warning { color: var(--warning); }
        .text-muted { color: var(--muted); }
        .text-sm { font-size: 11px; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .truncate {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .mt-2 { margin-top: 8px; }
        .mt-4 { margin-top: 16px; }
        .mb-2 { margin-bottom: 8px; }
        .flex { display: flex; }
        .gap-2 { gap: 8px; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
    </style>
</head>
<body x-data="ops()" x-init="init()">

    <div class="ops-grid">
        <!-- Header -->
        <header class="panel">
            <div class="logo">DAIMON <span>OPS</span></div>
            <div class="status-row">
                <template x-for="(status, name) in services" :key="name">
                    <div class="status-item">
                        <div class="dot" :class="status === 'healthy' || status === 'active' ? 'online' : 'offline'"></div>
                        <span x-text="name"></span>
                    </div>
                </template>
            </div>
            <div class="text-muted text-sm">
                <span x-text="lastUpdate"></span>
                <button class="btn btn-sm btn-primary" style="margin-left: 8px;" @click="refresh()">Refresh</button>
            </div>
        </header>

        <!-- Left Panel: Navigation & Quick Stats -->
        <div class="panel">
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-value" x-text="stats.corpus"></div>
                    <div class="stat-label">Corpus</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" x-text="stats.memory"></div>
                    <div class="stat-label">Memory</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" x-text="stats.precedents"></div>
                    <div class="stat-label">Precedents</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" x-text="stats.reflections"></div>
                    <div class="stat-label">Reflexoes</div>
                </div>
            </div>

            <div class="panel-header">
                <span class="panel-title">Collectors</span>
            </div>
            <template x-for="(data, name) in collectors" :key="name">
                <div class="list-item">
                    <div class="flex items-center gap-2">
                        <div class="dot" :class="data.process_running ? 'online' : 'offline'"></div>
                        <span x-text="name.replace('_', ' ')"></span>
                    </div>
                    <div>
                        <button class="btn btn-sm" :class="data.process_running ? 'btn-danger' : 'btn-success'"
                                @click="toggleCollector(name, data.process_running)">
                            <span x-text="data.process_running ? 'Stop' : 'Start'"></span>
                        </button>
                    </div>
                </div>
            </template>

            <div class="panel-header mt-4">
                <span class="panel-title">Preferencias</span>
                <button class="btn btn-sm btn-primary" @click="triggerReflection()" :disabled="reflecting">
                    <span x-text="reflecting ? '...' : 'Refletir'"></span>
                </button>
            </div>
            <template x-for="(data, cat) in preferences.current_preferences || {}" :key="cat">
                <div class="list-item" style="flex-direction: column; align-items: stretch;">
                    <div class="flex justify-between mb-2">
                        <span x-text="cat.replace('_', ' ')"></span>
                        <span class="mono" :class="data.trend === 'positive' ? 'text-success' : 'text-error'"
                              x-text="Math.round(data.approval_rate * 100) + '%'"></span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" :style="'width:' + (data.approval_rate * 100) + '%'"></div>
                    </div>
                </div>
            </template>
            <div x-show="!preferences.current_preferences || Object.keys(preferences.current_preferences).length === 0"
                 class="text-muted text-sm" style="padding: 12px;">
                Nenhuma preferencia detectada ainda.
            </div>

            <div class="panel-header mt-4">
                <span class="panel-title">Cognitive State</span>
            </div>
            <div class="stat-box">
                <div class="flex justify-between items-center">
                    <span x-text="cognitive.state || 'idle'" style="text-transform: capitalize;"></span>
                    <span class="mono text-muted" x-text="Math.round((cognitive.confidence || 0) * 100) + '%'"></span>
                </div>
                <div class="text-sm text-muted mt-2" x-show="cognitive.biometrics">
                    <div>Focus: <span x-text="Math.round((cognitive.biometrics?.focus_score || 0) * 100)"></span>%</div>
                    <div>Fatigue: <span x-text="Math.round((cognitive.biometrics?.fatigue_index || 0) * 100)"></span>%</div>
                </div>
            </div>
        </div>

        <!-- Main Panel -->
        <div class="panel">
            <div class="tabs">
                <button class="tab" :class="{ active: mainTab === 'corpus' }" @click="mainTab = 'corpus'">Corpus</button>
                <button class="tab" :class="{ active: mainTab === 'memory' }" @click="mainTab = 'memory'; loadMemory()">Memory</button>
                <button class="tab" :class="{ active: mainTab === 'precedents' }" @click="mainTab = 'precedents'; loadPrecedents()">Precedents</button>
                <button class="tab" :class="{ active: mainTab === 'claude' }" @click="mainTab = 'claude'; loadClaudeMd()">CLAUDE.md</button>
                <button class="tab" :class="{ active: mainTab === 'metacog' }" @click="mainTab = 'metacog'; loadMetacog()">Meta</button>
            </div>

            <!-- Corpus Tab -->
            <div x-show="mainTab === 'corpus'">
                <div class="flex justify-between items-center mb-2">
                    <div class="search-box" style="flex: 1; margin-right: 8px;">
                        <span class="search-icon">Q</span>
                        <input type="text" placeholder="Buscar no corpus..." x-model="corpusSearch" @keyup.enter="searchCorpus()">
                    </div>
                    <button class="btn btn-primary" @click="showCorpusAdd = true">+ Adicionar</button>
                </div>

                <div class="flex gap-2 mb-2">
                    <select x-model="corpusFilter.category" @change="filterCorpus()" style="width: auto;">
                        <option value="">Todas categorias</option>
                        <template x-for="cat in corpusCategories" :key="cat">
                            <option :value="cat" x-text="cat"></option>
                        </template>
                    </select>
                </div>

                <!-- Corpus Results -->
                <div style="max-height: calc(100vh - 250px); overflow: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Titulo</th>
                                <th>Autor</th>
                                <th>Categoria</th>
                                <th>Relevancia</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="text in corpusTexts" :key="text.id">
                                <tr>
                                    <td>
                                        <a href="#" @click.prevent="viewCorpusText(text)" class="truncate" style="max-width: 200px; display: block; color: var(--accent);"
                                           x-text="text.title"></a>
                                    </td>
                                    <td x-text="text.author" class="text-muted"></td>
                                    <td x-text="text.category" class="text-muted"></td>
                                    <td>
                                        <div class="progress-bar" style="width: 60px;">
                                            <div class="progress-fill" :style="'width:' + ((text.relevance || 0.5) * 100) + '%'"></div>
                                        </div>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-danger" @click="deleteCorpusText(text.id)">X</button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                    <div x-show="corpusTexts.length === 0" class="text-muted text-sm" style="padding: 20px; text-align: center;">
                        Nenhum texto encontrado. Adicione conteudo ao corpus.
                    </div>
                </div>
            </div>

            <!-- Memory Tab -->
            <div x-show="mainTab === 'memory'">
                <div class="search-box mb-2">
                    <span class="search-icon">Q</span>
                    <input type="text" placeholder="Buscar na memoria..." x-model="memorySearch" @keyup.enter="searchMemory()">
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Conteudo</th>
                            <th>Categoria</th>
                            <th>Importancia</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="item in memoryItems" :key="item.id">
                            <tr>
                                <td x-text="item.content" class="truncate" style="max-width: 400px;"></td>
                                <td x-text="item.category" class="text-muted"></td>
                                <td>
                                    <span class="mono" x-text="item.importance?.toFixed(2)"></span>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>

            <!-- Precedents Tab -->
            <div x-show="mainTab === 'precedents'">
                <div class="search-box mb-2">
                    <span class="search-icon">Q</span>
                    <input type="text" placeholder="Buscar precedentes..." x-model="precedentSearch" @keyup.enter="searchPrecedents()">
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Contexto</th>
                            <th>Decisao</th>
                            <th>Outcome</th>
                            <th>Licao</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="p in precedentItems" :key="p.id">
                            <tr>
                                <td x-text="p.context" class="truncate" style="max-width: 200px;"></td>
                                <td x-text="p.decision" class="truncate" style="max-width: 150px;"></td>
                                <td>
                                    <span :class="p.outcome === 'success' ? 'text-success' : (p.outcome === 'failure' ? 'text-error' : 'text-warning')"
                                          x-text="p.outcome"></span>
                                </td>
                                <td x-text="p.lesson" class="truncate text-muted" style="max-width: 200px;"></td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>

            <!-- CLAUDE.md Tab -->
            <div x-show="mainTab === 'claude'">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-muted text-sm">~/.claude/CLAUDE.md</span>
                    <div>
                        <button class="btn btn-sm" @click="loadClaudeMd()">Reload</button>
                        <button class="btn btn-sm btn-success" @click="saveClaudeMd()" :disabled="!claudeMdChanged">Save</button>
                    </div>
                </div>
                <textarea x-model="claudeMd" @input="claudeMdChanged = true"
                          style="width: 100%; height: calc(100vh - 200px); font-family: monospace; font-size: 12px;"></textarea>
            </div>

            <!-- Metacognitive Tab -->
            <div x-show="mainTab === 'metacog'">
                <div class="stats-grid mb-2">
                    <div class="stat-box">
                        <div class="stat-value" x-text="metacog.insights_analyzed || 0"></div>
                        <div class="stat-label">Insights Analisados</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" x-text="Math.round((metacog.overall_effectiveness || 0) * 100) + '%'"></div>
                        <div class="stat-label">Efetividade</div>
                    </div>
                </div>
                <div class="panel-header">
                    <span class="panel-title">Assessment</span>
                </div>
                <div class="stat-box mb-2">
                    <div x-text="metacog.assessment || 'N/A'" style="text-transform: capitalize; font-weight: bold;"></div>
                    <div class="text-muted text-sm" x-text="metacog.message || ''"></div>
                </div>
                <div class="panel-header">
                    <span class="panel-title">Recomendacoes</span>
                </div>
                <template x-for="rec in metacog.recommendations || []" :key="rec">
                    <div class="list-item text-sm" x-text="rec"></div>
                </template>
            </div>
        </div>

        <!-- Right Panel: Activity & Logs -->
        <div class="panel">
            <div class="panel-header">
                <span class="panel-title">Activity (24h)</span>
            </div>
            <div class="chart-container">
                <canvas id="activityChart"></canvas>
            </div>

            <div class="panel-header">
                <span class="panel-title">App Time</span>
            </div>
            <template x-for="(seconds, app) in appTime" :key="app">
                <div class="list-item">
                    <span x-text="app" class="truncate" style="max-width: 150px;"></span>
                    <span class="mono text-muted" x-text="formatDuration(seconds)"></span>
                </div>
            </template>
            <div x-show="Object.keys(appTime).length === 0" class="text-muted text-sm" style="padding: 12px;">
                Sem dados de apps.
            </div>

            <div class="panel-header mt-4">
                <span class="panel-title">Live Signals</span>
            </div>
            <div class="log-stream">
                <template x-for="log in activityLogs.slice(0, 30)" :key="log.id">
                    <div class="log-entry">
                        <span class="log-time" x-text="formatTime(log.timestamp)"></span>
                        <span class="log-type" :class="log.data?.signal_type" x-text="log.data?.signal_type || log.watcher_type"></span>
                        <span x-text="log.data?.category || log.data?.app || ''"></span>
                    </div>
                </template>
                <div x-show="activityLogs.length === 0" class="text-muted">Aguardando sinais...</div>
            </div>

            <div class="panel-header mt-4">
                <span class="panel-title">Style</span>
            </div>
            <div class="stat-box" x-show="style.style">
                <div class="text-sm">
                    <div>Pace: <span class="mono" x-text="style.style?.typing_pace || 'N/A'"></span></div>
                    <div>Focus: <span class="mono" x-text="style.style?.focus_level || 'N/A'"></span></div>
                    <div>Pattern: <span class="mono" x-text="style.style?.interaction_pattern || 'N/A'"></span></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Corpus Modal -->
    <div class="modal-overlay" x-show="showCorpusAdd" @click.self="showCorpusAdd = false" x-cloak>
        <div class="modal">
            <div class="modal-header">
                <h3>Adicionar ao Corpus</h3>
                <button class="modal-close" @click="showCorpusAdd = false">&times;</button>
            </div>
            <form @submit.prevent="addCorpusText()">
                <label>Titulo *</label>
                <input type="text" x-model="newCorpus.title" required>

                <label>Autor *</label>
                <input type="text" x-model="newCorpus.author" required>

                <label>Categoria *</label>
                <select x-model="newCorpus.category" required>
                    <option value="">Selecione...</option>
                    <template x-for="cat in corpusCategories" :key="cat">
                        <option :value="cat" x-text="cat"></option>
                    </template>
                </select>

                <label>Conteudo *</label>
                <textarea x-model="newCorpus.content" rows="8" required placeholder="Cole o texto aqui..."></textarea>

                <label>Temas (separados por virgula)</label>
                <input type="text" x-model="newCorpus.themes" placeholder="filosofia, etica, conhecimento">

                <label>Fonte</label>
                <input type="text" x-model="newCorpus.source" placeholder="URL ou referencia">

                <label>Relevancia</label>
                <input type="range" x-model="newCorpus.relevance" min="0" max="1" step="0.1">
                <span class="text-muted text-sm" x-text="newCorpus.relevance"></span>

                <div class="upload-zone mt-2" @dragover.prevent="$el.classList.add('dragover')"
                     @dragleave="$el.classList.remove('dragover')"
                     @drop.prevent="handleFileDrop($event)">
                    <div>Arraste arquivo TXT/MD aqui ou clique</div>
                    <input type="file" accept=".txt,.md,.pdf" @change="handleFileSelect($event)" style="display: none;" x-ref="fileInput">
                    <button type="button" class="btn btn-sm mt-2" @click="$refs.fileInput.click()">Selecionar Arquivo</button>
                </div>

                <div class="flex justify-between mt-4">
                    <button type="button" class="btn" @click="showCorpusAdd = false">Cancelar</button>
                    <button type="submit" class="btn btn-success">Adicionar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- View Corpus Text Modal -->
    <div class="modal-overlay" x-show="viewingCorpus" @click.self="viewingCorpus = null" x-cloak>
        <div class="modal">
            <div class="modal-header">
                <h3 x-text="viewingCorpus?.title"></h3>
                <button class="modal-close" @click="viewingCorpus = null">&times;</button>
            </div>
            <div class="text-muted text-sm mb-2">
                <span x-text="viewingCorpus?.author"></span> &middot;
                <span x-text="viewingCorpus?.category"></span>
            </div>
            <div style="white-space: pre-wrap; max-height: 60vh; overflow: auto; background: var(--bg); padding: 12px; border-radius: 4px;"
                 x-text="viewingCorpus?.content"></div>
            <div class="text-muted text-sm mt-2" x-show="viewingCorpus?.themes?.length">
                Temas: <span x-text="viewingCorpus?.themes?.join(', ')"></span>
            </div>
        </div>
    </div>

    <script>
        function ops() {
            return {
                // State
                services: {},
                collectors: {},
                preferences: {},
                cognitive: {},
                style: {},
                stats: { corpus: 0, memory: 0, precedents: 0, reflections: 0 },
                appTime: {},
                activityLogs: [],
                lastUpdate: '',
                reflecting: false,

                // Tabs
                mainTab: 'corpus',

                // Corpus
                corpusTexts: [],
                corpusCategories: [],
                corpusSearch: '',
                corpusFilter: { category: '' },
                showCorpusAdd: false,
                viewingCorpus: null,
                newCorpus: {
                    title: '', author: '', category: '', content: '',
                    themes: '', source: '', relevance: 0.5
                },

                // Memory
                memoryItems: [],
                memorySearch: '',

                // Precedents
                precedentItems: [],
                precedentSearch: '',

                // CLAUDE.md
                claudeMd: '',
                claudeMdChanged: false,

                // Metacognitive
                metacog: {},

                // Chart
                activityChart: null,

                async init() {
                    await this.refresh();
                    await this.loadCorpus();
                    this.initChart();
                    setInterval(() => this.refresh(), 10000);
                    setInterval(() => this.loadActivity(), 5000);
                },

                async refresh() {
                    try {
                        const [status, prefs, colls, corpusStats, memStats, precStats, activity, apps, cog, sty] = await Promise.all([
                            fetch('/api/status').then(r => r.json()),
                            fetch('/api/preferences').then(r => r.json()),
                            fetch('/api/collectors').then(r => r.json()),
                            fetch('/api/corpus/stats').then(r => r.json()),
                            fetch('/api/memory/stats').then(r => r.json()),
                            fetch('/api/precedents/stats').then(r => r.json()),
                            fetch('/api/activity/recent?limit=50').then(r => r.json()),
                            fetch('/api/activity/apps').then(r => r.json()),
                            fetch('/api/cognitive').then(r => r.json()),
                            fetch('/api/style').then(r => r.json())
                        ]);

                        this.services = status;
                        this.preferences = prefs;
                        this.collectors = colls;
                        this.cognitive = cog;
                        this.style = sty;

                        this.stats.corpus = corpusStats.total_texts || 0;
                        this.stats.memory = memStats.total_items || 0;
                        this.stats.precedents = precStats.total_precedents || 0;
                        this.stats.reflections = prefs.total_reflections || 0;

                        this.activityLogs = activity.records || [];
                        this.appTime = apps.apps || {};

                        this.lastUpdate = new Date().toLocaleTimeString();
                        this.updateChart();
                    } catch (e) {
                        console.error('Refresh error:', e);
                    }
                },

                async loadCorpus() {
                    try {
                        const [texts, tree] = await Promise.all([
                            fetch('/api/corpus/texts').then(r => r.json()),
                            fetch('/api/corpus/tree').then(r => r.json())
                        ]);
                        this.corpusTexts = texts.texts || [];
                        this.corpusCategories = tree.categories || [];
                    } catch (e) {
                        console.error('Load corpus error:', e);
                    }
                },

                async searchCorpus() {
                    if (!this.corpusSearch) {
                        await this.loadCorpus();
                        return;
                    }
                    try {
                        const res = await fetch(`/api/corpus/search?q=${encodeURIComponent(this.corpusSearch)}&limit=50`);
                        const data = await res.json();
                        this.corpusTexts = data.results || [];
                    } catch (e) {
                        console.error('Search error:', e);
                    }
                },

                filterCorpus() {
                    // Re-fetch with category filter would be better, but for now client-side filter
                    this.loadCorpus();
                },

                async addCorpusText() {
                    try {
                        const themes = this.newCorpus.themes.split(',').map(t => t.trim()).filter(t => t);
                        const res = await fetch('/api/corpus/text', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                title: this.newCorpus.title,
                                author: this.newCorpus.author,
                                category: this.newCorpus.category,
                                content: this.newCorpus.content,
                                themes: themes,
                                source: this.newCorpus.source,
                                relevance: parseFloat(this.newCorpus.relevance)
                            })
                        });
                        const data = await res.json();
                        if (data.error) {
                            alert('Erro: ' + data.error);
                        } else {
                            this.showCorpusAdd = false;
                            this.newCorpus = { title: '', author: '', category: '', content: '', themes: '', source: '', relevance: 0.5 };
                            await this.loadCorpus();
                            await this.refresh();
                        }
                    } catch (e) {
                        alert('Erro: ' + e.message);
                    }
                },

                async deleteCorpusText(id) {
                    if (!confirm('Remover este texto do corpus?')) return;
                    try {
                        await fetch(`/api/corpus/text/${id}`, { method: 'DELETE' });
                        await this.loadCorpus();
                        await this.refresh();
                    } catch (e) {
                        alert('Erro: ' + e.message);
                    }
                },

                viewCorpusText(text) {
                    this.viewingCorpus = text;
                },

                handleFileDrop(event) {
                    event.target.classList.remove('dragover');
                    const file = event.dataTransfer.files[0];
                    if (file) this.readFile(file);
                },

                handleFileSelect(event) {
                    const file = event.target.files[0];
                    if (file) this.readFile(file);
                },

                readFile(file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.newCorpus.content = e.target.result;
                        if (!this.newCorpus.title) {
                            this.newCorpus.title = file.name.replace(/\.[^/.]+$/, '');
                        }
                    };
                    reader.readAsText(file);
                },

                async loadMemory() {
                    try {
                        const res = await fetch('/api/memory/search?q=&limit=50');
                        const data = await res.json();
                        this.memoryItems = data.results || [];
                    } catch (e) {
                        console.error('Load memory error:', e);
                    }
                },

                async searchMemory() {
                    try {
                        const res = await fetch(`/api/memory/search?q=${encodeURIComponent(this.memorySearch)}&limit=50`);
                        const data = await res.json();
                        this.memoryItems = data.results || [];
                    } catch (e) {
                        console.error('Search memory error:', e);
                    }
                },

                async loadPrecedents() {
                    try {
                        const res = await fetch('/api/precedents/search?q=&limit=50');
                        const data = await res.json();
                        this.precedentItems = data.results || [];
                    } catch (e) {
                        console.error('Load precedents error:', e);
                    }
                },

                async searchPrecedents() {
                    try {
                        const res = await fetch(`/api/precedents/search?q=${encodeURIComponent(this.precedentSearch)}&limit=50`);
                        const data = await res.json();
                        this.precedentItems = data.results || [];
                    } catch (e) {
                        console.error('Search precedents error:', e);
                    }
                },

                async loadClaudeMd() {
                    try {
                        const res = await fetch('/api/claude-md');
                        const data = await res.json();
                        this.claudeMd = data.content || '';
                        this.claudeMdChanged = false;
                    } catch (e) {
                        console.error('Load CLAUDE.md error:', e);
                    }
                },

                async saveClaudeMd() {
                    try {
                        await fetch('/api/claude-md', {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ content: this.claudeMd })
                        });
                        this.claudeMdChanged = false;
                        alert('Salvo!');
                    } catch (e) {
                        alert('Erro: ' + e.message);
                    }
                },

                async loadMetacog() {
                    try {
                        const res = await fetch('/api/metacognitive');
                        this.metacog = await res.json();
                    } catch (e) {
                        console.error('Load metacog error:', e);
                    }
                },

                async loadActivity() {
                    try {
                        const res = await fetch('/api/activity/recent?limit=50');
                        const data = await res.json();
                        this.activityLogs = data.records || [];
                    } catch (e) {
                        console.error('Load activity error:', e);
                    }
                },

                async toggleCollector(name, isRunning) {
                    const action = isRunning ? 'stop' : 'start';
                    try {
                        await fetch(`/api/collectors/${name}/${action}`, { method: 'POST' });
                        await new Promise(r => setTimeout(r, 1000));
                        await this.refresh();
                    } catch (e) {
                        console.error('Toggle collector error:', e);
                    }
                },

                async triggerReflection() {
                    this.reflecting = true;
                    try {
                        await fetch('/api/reflect', { method: 'POST' });
                        await this.refresh();
                    } catch (e) {
                        console.error('Reflection error:', e);
                    }
                    this.reflecting = false;
                },

                initChart() {
                    const ctx = document.getElementById('activityChart');
                    if (!ctx) return;

                    this.activityChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'Signals',
                                data: [],
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                x: { display: false },
                                y: { display: true, grid: { color: '#2a2a2a' } }
                            }
                        }
                    });
                },

                updateChart() {
                    if (!this.activityChart) return;

                    // Group activity by hour
                    const hourCounts = {};
                    for (const log of this.activityLogs) {
                        const hour = new Date(log.timestamp).getHours();
                        hourCounts[hour] = (hourCounts[hour] || 0) + 1;
                    }

                    const labels = [];
                    const data = [];
                    for (let h = 0; h < 24; h++) {
                        labels.push(h + 'h');
                        data.push(hourCounts[h] || 0);
                    }

                    this.activityChart.data.labels = labels;
                    this.activityChart.data.datasets[0].data = data;
                    this.activityChart.update();
                },

                formatTime(iso) {
                    if (!iso) return '';
                    return new Date(iso).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                },

                formatDuration(s) {
                    if (!s) return '0s';
                    const h = Math.floor(s / 3600);
                    const m = Math.floor((s % 3600) / 60);
                    if (h > 0) return `${h}h ${m}m`;
                    return `${m}m`;
                }
            };
        }
    </script>
</body>
</html>
