<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DAIMON - Sophia</title>
    <link rel="stylesheet" href="/static/css/sophia.css">
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>[x-cloak] { display: none !important; }</style>
</head>
<body x-data="daimon()" x-init="init()" x-cloak :class="mode + '-mode'">

    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <h1 class="logo-title">DAIMON</h1>
                <span class="logo-subtitle">Exocortex</span>
            </div>

            <div class="mode-switcher">
                <button class="mode-btn" :class="{ active: mode === 'sophia' }" @click="setMode('sophia')">
                    <span class="greek">Œ£ŒøœÜŒØŒ±</span>
                </button>
                <button class="mode-btn" :class="{ active: mode === 'athena' }" @click="setMode('athena')">
                    <span class="greek">·ºàŒ∏Œ∑ŒΩ·æ∂</span>
                </button>
            </div>

            <div class="status-indicator">
                <span x-text="lastUpdate" class="text-muted" style="font-size: 0.75rem;"></span>
            </div>
        </header>

        <!-- ============================================
             SOPHIA MODE - Contemplative
             ============================================ -->
        <template x-if="mode === 'sophia'">
            <main class="page-transition">
                <!-- Oracle Section -->
                <section class="oracle-section">
                    <h2 class="oracle-title greek">Œ£ŒüŒ¶ŒôŒë</h2>
                    <p class="oracle-quote">"Know thyself"</p>

                    <!-- Breathing Pulse -->
                    <div class="oracle-pulse"></div>

                    <!-- NOESIS Status -->
                    <div class="oracle-status" :class="services.noesis === 'healthy' ? 'online' : 'offline'">
                        NOESIS <span x-text="services.noesis === 'healthy' ? '‚óè Online' : '‚óã Offline'"></span>
                    </div>
                </section>

                <!-- Insight Cards -->
                <section class="insights-grid">
                    <div class="insight-card">
                        <div class="insight-icon">üìú</div>
                        <h3 class="insight-title">Corpus</h3>
                        <div class="insight-value" x-text="corpusStats.total_texts || 0"></div>
                        <div class="insight-label">textos de sabedoria</div>
                    </div>

                    <div class="insight-card">
                        <div class="insight-icon">üîÆ</div>
                        <h3 class="insight-title">Reflexoes</h3>
                        <div class="insight-value" x-text="preferences.total_reflections || 0"></div>
                        <div class="insight-label">ciclos completos</div>
                    </div>

                    <div class="insight-card">
                        <div class="insight-icon">üí≠</div>
                        <h3 class="insight-title">Sinais</h3>
                        <div class="insight-value" x-text="preferences.signals_in_memory || 0"></div>
                        <div class="insight-label">em memoria</div>
                    </div>

                    <div class="insight-card">
                        <div class="insight-icon">‚öñÔ∏è</div>
                        <h3 class="insight-title">Precedentes</h3>
                        <div class="insight-value" x-text="precedentStats.total_precedents || 0"></div>
                        <div class="insight-label">jurisprudencia</div>
                    </div>
                </section>

                <!-- Wisdom Stream -->
                <section class="wisdom-stream" x-show="insights.length > 0">
                    <h3 style="font-family: 'Playfair Display', serif; margin-bottom: var(--space-md); color: var(--olive-gold);">
                        Insights Recentes
                    </h3>
                    <template x-for="(insight, i) in insights.slice(0, 5)" :key="i">
                        <div class="wisdom-item slide-up" :style="'animation-delay: ' + (i * 0.1) + 's'">
                            <span class="wisdom-time" x-text="insight.time || ''"></span>
                            <span class="wisdom-text" x-text="insight.text"></span>
                            <span class="wisdom-category" x-text="insight.category"></span>
                        </div>
                    </template>
                </section>

                <!-- Preference Summary -->
                <section class="wisdom-stream mt-xl" x-show="Object.keys(preferences.current_preferences || {}).length > 0">
                    <h3 style="font-family: 'Playfair Display', serif; margin-bottom: var(--space-md); color: var(--olive-gold);">
                        Preferencias Aprendidas
                    </h3>
                    <template x-for="(data, category) in preferences.current_preferences" :key="category">
                        <div class="wisdom-item">
                            <span class="wisdom-category" x-text="category.replace('_', ' ')"></span>
                            <div style="flex: 1; display: flex; align-items: center; gap: var(--space-md);">
                                <div class="progress-bar" style="flex: 1; height: 6px;">
                                    <div class="progress-fill"
                                         :class="data.trend === 'positive' ? 'positive' : (data.trend === 'negative' ? 'negative' : '')"
                                         :style="'width: ' + (data.approval_rate * 100) + '%'">
                                    </div>
                                </div>
                                <span class="mono" style="font-size: 0.875rem; color: var(--gold-leaf);"
                                      x-text="Math.round(data.approval_rate * 100) + '%'"></span>
                            </div>
                        </div>
                    </template>
                </section>

                <!-- Actions -->
                <section class="text-center mt-xl">
                    <button @click="triggerReflection()"
                            :disabled="reflecting"
                            style="padding: var(--space-md) var(--space-xl); background: var(--gold-leaf); color: white; border: none; border-radius: var(--space-sm); font-family: 'Playfair Display', serif; font-size: 1rem; cursor: pointer; transition: all 0.3s;">
                        <span x-show="!reflecting">Iniciar Reflexao</span>
                        <span x-show="reflecting">Refletindo...</span>
                    </button>
                </section>
            </main>
        </template>

        <!-- ============================================
             ATHENA MODE - Analytical
             ============================================ -->
        <template x-if="mode === 'athena'">
            <main class="page-transition">
                <!-- Stats Overview -->
                <section class="data-section">
                    <div class="section-header">
                        <h2 class="section-title">Visao Geral</h2>
                        <button class="btn btn-primary" @click="refresh()">Atualizar</button>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" x-text="preferences.total_reflections || 0"></div>
                            <div class="stat-label">Reflexoes</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" x-text="preferences.total_updates || 0"></div>
                            <div class="stat-label">Updates</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" x-text="preferences.signals_in_memory || 0"></div>
                            <div class="stat-label">Sinais</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" x-text="corpusStats.total_texts || 0"></div>
                            <div class="stat-label">Textos</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" x-text="precedentStats.total_precedents || 0"></div>
                            <div class="stat-label">Precedentes</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" x-text="memoryStats.total_items || 0"></div>
                            <div class="stat-label">Memorias</div>
                        </div>
                    </div>
                </section>

                <div class="main-grid">
                    <!-- Services Status -->
                    <section class="data-section">
                        <div class="section-header">
                            <h2 class="section-title">Servicos</h2>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Servico</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="(status, service) in services" :key="service">
                                    <tr>
                                        <td x-text="service"></td>
                                        <td>
                                            <span class="status-dot" :class="status === 'healthy' || status === 'active' ? 'online' : 'offline'"></span>
                                            <span x-text="status"></span>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </section>

                    <!-- Collectors -->
                    <section class="data-section">
                        <div class="section-header">
                            <h2 class="section-title">Collectors</h2>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Collector</th>
                                    <th>Status</th>
                                    <th>Acoes</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="(data, name) in collectors" :key="name">
                                    <tr>
                                        <td x-text="name"></td>
                                        <td>
                                            <span class="status-dot" :class="data.process_running ? 'online' : 'offline'"></span>
                                            <span x-text="data.process_running ? 'Running' : 'Stopped'"></span>
                                        </td>
                                        <td>
                                            <button class="btn btn-secondary" @click="startCollector(name)" :disabled="data.process_running">Start</button>
                                            <button class="btn btn-secondary" @click="stopCollector(name)" :disabled="!data.process_running">Stop</button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </section>

                    <!-- Preferences Data -->
                    <section class="data-section full-width">
                        <div class="section-header">
                            <h2 class="section-title">Preferencias Detectadas</h2>
                            <button class="btn btn-primary" @click="triggerReflection()" :disabled="reflecting">
                                <span x-text="reflecting ? 'Processando...' : 'Refletir Agora'"></span>
                            </button>
                        </div>
                        <div class="filters-bar">
                            <span style="font-size: 0.75rem; color: var(--athena-muted);">
                                Ultima reflexao: <span x-text="preferences.last_reflection || 'nunca'"></span>
                            </span>
                        </div>
                        <template x-if="Object.keys(preferences.current_preferences || {}).length > 0">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Categoria</th>
                                        <th>Aprovacao</th>
                                        <th>Tendencia</th>
                                        <th>Sinais</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="(data, category) in preferences.current_preferences" :key="category">
                                        <tr>
                                            <td x-text="category"></td>
                                            <td>
                                                <div style="display: flex; align-items: center; gap: var(--space-sm);">
                                                    <div class="progress-bar" style="width: 100px;">
                                                        <div class="progress-fill" :style="'width: ' + (data.approval_rate * 100) + '%'"></div>
                                                    </div>
                                                    <span class="mono" x-text="Math.round(data.approval_rate * 100) + '%'"></span>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="signal-badge" :class="data.trend === 'positive' ? 'approval' : 'rejection'"
                                                      x-text="data.trend"></span>
                                            </td>
                                            <td class="mono" x-text="data.total_signals"></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </template>
                        <template x-if="Object.keys(preferences.current_preferences || {}).length === 0">
                            <div class="p-lg text-center text-muted">
                                Nenhuma preferencia detectada. Execute uma reflexao.
                            </div>
                        </template>
                    </section>

                    <!-- Activity -->
                    <section class="data-section full-width">
                        <div class="section-header">
                            <h2 class="section-title">Atividade Recente</h2>
                        </div>
                        <div class="tabs">
                            <button class="tab-btn" :class="{ active: activityTab === 'signals' }" @click="activityTab = 'signals'">Sinais</button>
                            <button class="tab-btn" :class="{ active: activityTab === 'apps' }" @click="activityTab = 'apps'; loadAppTime()">Apps</button>
                            <button class="tab-btn" :class="{ active: activityTab === 'raw' }" @click="activityTab = 'raw'; loadRawActivity()">Raw Data</button>
                        </div>

                        <!-- Signals Tab -->
                        <div x-show="activityTab === 'signals'">
                            <template x-if="activityRecords.length > 0">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Timestamp</th>
                                            <th>Watcher</th>
                                            <th>Tipo</th>
                                            <th>Dados</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <template x-for="record in activityRecords.slice(0, 20)" :key="record.id">
                                            <tr>
                                                <td class="mono" x-text="formatTime(record.timestamp)"></td>
                                                <td x-text="record.watcher_type"></td>
                                                <td>
                                                    <span class="signal-badge" :class="record.data?.signal_type === 'approval' ? 'approval' : 'rejection'"
                                                          x-text="record.data?.signal_type || 'event'"></span>
                                                </td>
                                                <td class="mono" style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"
                                                    x-text="JSON.stringify(record.data).substring(0, 60) + '...'"></td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </template>
                            <template x-if="activityRecords.length === 0">
                                <div class="p-lg text-center text-muted">Sem atividade recente.</div>
                            </template>
                        </div>

                        <!-- Apps Tab -->
                        <div x-show="activityTab === 'apps'">
                            <template x-if="Object.keys(appTime).length > 0">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Aplicativo</th>
                                            <th>Tempo (24h)</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <template x-for="(seconds, app) in appTime" :key="app">
                                            <tr>
                                                <td x-text="app"></td>
                                                <td class="mono" x-text="formatDuration(seconds)"></td>
                                                <td>
                                                    <div class="progress-bar" style="width: 150px;">
                                                        <div class="progress-fill" :style="'width: ' + Math.min(100, (seconds / 3600) * 100) + '%'"></div>
                                                    </div>
                                                </td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </template>
                            <template x-if="Object.keys(appTime).length === 0">
                                <div class="p-lg text-center text-muted">Sem dados de aplicativos.</div>
                            </template>
                        </div>

                        <!-- Raw Data Tab -->
                        <div x-show="activityTab === 'raw'" style="max-height: 400px; overflow: auto;">
                            <pre class="mono p-md" style="font-size: 0.75rem; background: var(--athena-bg);"
                                 x-text="JSON.stringify(activityRecords.slice(0, 10), null, 2)"></pre>
                        </div>
                    </section>

                    <!-- CLAUDE.md Editor -->
                    <section class="data-section full-width">
                        <div class="section-header">
                            <h2 class="section-title">CLAUDE.md</h2>
                            <div style="display: flex; gap: var(--space-sm);">
                                <button class="btn btn-secondary" @click="loadClaudeMd()">Reload</button>
                                <button class="btn btn-primary" @click="saveClaudeMd()" :disabled="!claudeMdChanged">Save</button>
                            </div>
                        </div>
                        <textarea x-model="claudeMd"
                                  @input="claudeMdChanged = true"
                                  class="mono"
                                  style="width: 100%; height: 300px; padding: var(--space-md); background: var(--athena-bg); color: var(--athena-text); border: none; resize: vertical; font-size: 0.8125rem;">
                        </textarea>
                        <div class="filters-bar" style="justify-content: space-between;">
                            <span x-show="claudeMdChanged" style="color: var(--gold-leaf);">Alteracoes nao salvas</span>
                            <span x-text="claudeMdExists ? 'Arquivo existe' : 'Sera criado'"></span>
                        </div>
                    </section>
                </div>
            </main>
        </template>

        <!-- Footer -->
        <footer style="text-align: center; padding: var(--space-xl) 0; margin-top: var(--space-xl);">
            <p class="text-muted" style="font-size: 0.75rem;">
                DAIMON v2.0 &middot; Porta 8003
            </p>
        </footer>
    </div>

    <script>
        function daimon() {
            return {
                // Mode
                mode: localStorage.getItem('daimon-mode') || 'sophia',

                // Data
                services: {},
                preferences: {},
                collectors: {},
                corpusStats: {},
                precedentStats: {},
                memoryStats: {},
                insights: [],

                // CLAUDE.md
                claudeMd: '',
                claudeMdExists: false,
                claudeMdChanged: false,

                // Activity
                activityTab: 'signals',
                activityRecords: [],
                appTime: {},

                // State
                reflecting: false,
                lastUpdate: '',

                // Init
                async init() {
                    await this.refresh();
                    setInterval(() => this.refresh(), 15000);
                },

                // Mode switcher
                setMode(newMode) {
                    this.mode = newMode;
                    localStorage.setItem('daimon-mode', newMode);
                },

                // Refresh all data
                async refresh() {
                    try {
                        const [
                            statusRes,
                            prefsRes,
                            collectorsRes,
                            corpusRes,
                            precedentRes,
                            memoryRes,
                            activityRes
                        ] = await Promise.all([
                            fetch('/api/status'),
                            fetch('/api/preferences'),
                            fetch('/api/collectors'),
                            fetch('/api/corpus/stats'),
                            fetch('/api/precedents/stats'),
                            fetch('/api/memory/stats'),
                            fetch('/api/activity/recent?limit=50')
                        ]);

                        this.services = await statusRes.json();
                        this.preferences = await prefsRes.json();
                        this.collectors = await collectorsRes.json();
                        this.corpusStats = await corpusRes.json();
                        this.precedentStats = await precedentRes.json();
                        this.memoryStats = await memoryRes.json();

                        const activity = await activityRes.json();
                        this.activityRecords = activity.records || [];

                        // Generate insights for Sophia mode
                        this.generateInsights();

                        // Load CLAUDE.md if not editing
                        if (!this.claudeMdChanged) {
                            await this.loadClaudeMd();
                        }

                        this.lastUpdate = new Date().toLocaleTimeString();
                    } catch (e) {
                        console.error('Refresh failed:', e);
                    }
                },

                // Generate insights from data
                generateInsights() {
                    this.insights = [];

                    // From preferences
                    if (this.preferences.current_preferences) {
                        for (const [cat, data] of Object.entries(this.preferences.current_preferences)) {
                            if (data.trend === 'positive') {
                                this.insights.push({
                                    text: `Tendencia positiva em ${cat.replace('_', ' ')}`,
                                    category: cat,
                                    time: 'recente'
                                });
                            } else if (data.trend === 'negative' && data.total_signals > 3) {
                                this.insights.push({
                                    text: `Atencao: ${cat.replace('_', ' ')} precisa ajuste`,
                                    category: cat,
                                    time: 'recente'
                                });
                            }
                        }
                    }

                    // From activity
                    const recentClaudeEvents = this.activityRecords.filter(r => r.watcher_type === 'claude');
                    if (recentClaudeEvents.length > 10) {
                        this.insights.push({
                            text: `${recentClaudeEvents.length} interacoes Claude detectadas`,
                            category: 'activity',
                            time: '24h'
                        });
                    }
                },

                // CLAUDE.md operations
                async loadClaudeMd() {
                    try {
                        const res = await fetch('/api/claude-md');
                        const data = await res.json();
                        this.claudeMd = data.content || '';
                        this.claudeMdExists = data.exists;
                        this.claudeMdChanged = false;
                    } catch (e) {
                        console.error('Load CLAUDE.md failed:', e);
                    }
                },

                async saveClaudeMd() {
                    try {
                        await fetch('/api/claude-md', {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ content: this.claudeMd })
                        });
                        this.claudeMdChanged = false;
                        alert('Salvo!');
                    } catch (e) {
                        alert('Erro: ' + e.message);
                    }
                },

                // Reflection
                async triggerReflection() {
                    this.reflecting = true;
                    try {
                        const res = await fetch('/api/reflect', { method: 'POST' });
                        const data = await res.json();
                        await this.refresh();

                        if (this.mode === 'sophia') {
                            this.insights.unshift({
                                text: `Reflexao concluida: ${data.insights_count} insights`,
                                category: 'reflection',
                                time: 'agora'
                            });
                        } else {
                            alert(`Reflexao concluida!\nSinais: ${data.signals_count}\nInsights: ${data.insights_count}`);
                        }
                    } catch (e) {
                        alert('Erro: ' + e.message);
                    }
                    this.reflecting = false;
                },

                // Collectors
                async startCollector(name) {
                    await fetch(`/api/collectors/${name}/start`, { method: 'POST' });
                    await new Promise(r => setTimeout(r, 1000));
                    await this.refresh();
                },

                async stopCollector(name) {
                    await fetch(`/api/collectors/${name}/stop`, { method: 'POST' });
                    await this.refresh();
                },

                // Activity tabs
                async loadAppTime() {
                    try {
                        const res = await fetch('/api/activity/apps');
                        const data = await res.json();
                        this.appTime = data.apps || {};
                    } catch (e) {
                        console.error('Load app time failed:', e);
                    }
                },

                async loadRawActivity() {
                    // Already loaded in activityRecords
                },

                // Formatters
                formatTime(isoString) {
                    if (!isoString) return '';
                    const d = new Date(isoString);
                    return d.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                },

                formatDuration(seconds) {
                    if (!seconds) return '0s';
                    const h = Math.floor(seconds / 3600);
                    const m = Math.floor((seconds % 3600) / 60);
                    const s = Math.floor(seconds % 60);
                    if (h > 0) return `${h}h ${m}m`;
                    if (m > 0) return `${m}m ${s}s`;
                    return `${s}s`;
                }
            };
        }
    </script>
</body>
</html>
